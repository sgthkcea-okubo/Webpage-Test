<!DOCTYPE html>
<html>

<head>
    <title>Experiment</title>
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.1.0"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <meta charset="UTF-8">
    <script src="https://sgthkcea-okubo.github.io/jspsych-psychophysics/jspsych-psychophysics.js"></script>
    <script src="https://sgthkcea-okubo.github.io/jsPsychSheet/jspsychsheet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="//code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body></body>

<script>
    // timelineの定義を先に移動
    var timeline = [];

    const jsPsych = initJsPsych({
        timeline: timeline,
        on_finish: function () {
            url = "https://script.google.com/macros/s/AKfycbwAWhEmQ1w-jnAPvtOmlzykqsUS9ZHZv0ZRpa92KpV-_4938mt0bWAySZG-NZ2x8qU/exec";
            jsPsychSheet.uploadData(url, jsPsych.data.get().csv())
        }
    });

    // 条件のランダムサンプリング
    var condition = jsPsych.randomization.sampleWithReplacement([0, 1], 1)[0];

    var welcome = {
        type: jsPsychHtmlButtonResponse,
        stimulus:
            '<p>（インフォームドコンセント）</p>',
        choices: ['アンケートに進む']
    };
    timeline.push(welcome);

    const colorset1_1 = ["blue"];
    const colorset1_2 = ["yellow"];
    const colorset1 = [colorset1_1, colorset1_2];

    const num_of_loops = 10;

    for (var i = 0; i < num_of_loops; i++) {

        var colorcond1 = jsPsych.randomization.sampleWithReplacement(colorset1, 1)[0];
        var colorcond2 = jsPsych.randomization.sampleWithReplacement(_.difference(colorset1, [colorcond1]), 1)[0];

        var color1 = jsPsych.randomization.sampleWithReplacement(colorcond1, 1)[0];

        var color2;
        if (condition == 0) {
            color2 = jsPsych.randomization.sampleWithReplacement(colorcond1, 1)[0];
        }
        else if (condition == 1) {
            color2 = jsPsych.randomization.sampleWithReplacement(colorcond2, 1)[0];
        }

        var a = jsPsych.randomization.sampleWithReplacement([-50, 50], 1)[0];
        var b = 0;

        const illusion_or_not = {
            type: jsPsychHtmlSliderResponse,
            stimulus: `
                <div style="width:1000px; margin: 0 auto;">
                  <p style="text-align:center;">
                    画像に示された2つの図形について、<br>
                    大きさが等しいと感じるようにスライダーの位置を調整し、"次に進む"を押してください。
                  </p>
                  <div style="display:flex; justify-content:center;">
                    <canvas id="illusion_canvas_${i}" width="800" height="400" style="background:white; border:1px solid #ccc;"></canvas>
                  </div>
                </div>
            `,
            min: -50,
            max: 50,
            value: 0,
            step: 1,
            labels: ['-50', '0', '50'],
            button_label: '次に進む',
            require_movement: true,
            on_load: function() {
                const base_radius = 100;
                const offset = a;
                const left_color = color1;
                const right_color = color2;
                function drawIllusion(r_diff) {
                    const canvas = document.getElementById('illusion_canvas_' + i);
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    // 左円
                    ctx.beginPath();
                    ctx.arc(250, 200, base_radius - offset, 0, 2 * Math.PI);
                    ctx.fillStyle = left_color;
                    ctx.globalAlpha = 0.5;
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                    ctx.strokeStyle = left_color;
                    ctx.stroke();
                    // 右円
                    ctx.beginPath();
                    ctx.arc(550, 200, base_radius + offset + Number(r_diff), 0, 2 * Math.PI);
                    ctx.fillStyle = right_color;
                    ctx.globalAlpha = 0.5;
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                    ctx.strokeStyle = right_color;
                    ctx.stroke();
                }
                drawIllusion(0);
                const slider = document.querySelector('input[type=range]');
                if(slider){
                    slider.addEventListener('input', function(){
                        drawIllusion(this.value);
                    });
                }
            }
        };
        timeline.push(illusion_or_not);

        var confidence_level = {
            type: jsPsychHtmlSliderResponse,
            stimulus: '<div style="width:500px;">' +
                '<p>直前の質問が正しい確率について、<br>自己評価したものを回答してください。</p>' +
                '</div>',
            name: 'confidence_level_' + i,
            button_label: '次に進む',
            require_movement: true,
            labels: ['0%', '100%'],
        };
        timeline.push(confidence_level);

        var model_answer = {
            type: jsPsychHtmlButtonResponse,
            stimulus: "正答は「" + (-a) + "」です。",
            name: "model_answer_" + i,
            choices: ['次に進む']
        };
        timeline.push(model_answer);
    }

    var age = {
        type: jsPsychSurveyText,
        questions: [
            { prompt: '年齢を入力してください', columns: 3, required: true, name: 'age' },
        ],
        button_label: '次へ',
    };
    timeline.push(age);

    var gender = {
        type: jsPsychSurveyMultiChoice,
        questions: [
            { prompt: "性別を選択してください", options: ['男性', '女性', 'その他'], required: true, horizontal: true, name: 'gender' },
        ],
        button_label: '次へ',
    };
    timeline.push(gender);

    var finish = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<p>これでアンケートは終わりです。<br>' +
            'ありがとうございました。(press the "A" key to send data.)</p>',
        choices: 'a' //'NO_KEYS'
    };
    timeline.push(finish);

    jsPsych.run(timeline);

</script>

</html>
